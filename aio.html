<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>HPC Workflow Management with Snakemake: All in One View</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="assets/styles.css">
<script src="assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="manifest" href="site.webmanifest">
<link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>
    <header id="top" class="navbar navbar-expand-md navbar-light bg-white top-nav incubator"><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-6">
      <div class="large-logo">
        <img alt="Carpentries Incubator" src="assets/images/incubator-logo.svg"><abbr class="badge badge-light" title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught." style="background-color: #FF4955; border-radius: 5px">
          <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#early-development-pre-alpha-through-alpha" class="external-link alert-link" style="color: #000">
            <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="border-radius: 5px"></i>
            Pre-Alpha
          </a>
          <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
        </abbr>
        
      </div>
    </div>
    <div class="selector-container">
      
      
      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Learner View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
<li><button class="dropdown-item" type="button" onclick="window.location.href='instructor/aio.html';">Instructor View</button></li>
        </ul>
</div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl navbar-light bg-white bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Carpentries Incubator" src="assets/images/incubator-logo-sm.svg">
</div>
    <div class="lesson-title-md">
      HPC Workflow Management with Snakemake
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="search button" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item">
          <span class="lesson-title">
            HPC Workflow Management with Snakemake
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="reference.html#glossary">Glossary</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="profiles.html">Learner Profiles</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
<li><a class="dropdown-item" href="reference.html">Reference</a></li>
          </ul>
</li>
      </ul>
</div>
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
<input class="form-control me-2 searchbox" type="search" placeholder="Search" aria-label="Search"><button class="btn btn-outline-success tablet-search-button" type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="search button"></i>
        </button>
      </fieldset>
</form>
  </div>
<!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  HPC Workflow Management with Snakemake
</div>

<aside class="col-md-12 lesson-progress"><div style="width: %" class="percentage">
    %
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: %" aria-valuenow="" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Learner View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="instructor/aio.html">Instructor View</a>
                      </div>
                    </div>
                  </div>
<!--/div.accordion-item-->
                </div>
<!--/div.accordion-flush-->
              </div>
<!--div.sidenav-view-selector -->
            </div>
<!--/div.col -->
      
            <hr>
</div>
<!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Setup</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="01-introduction.html">1. Running commands with Snakemake</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="02-snakemake_on_the_cluster.html">2. Running Snakemake on the cluster</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="03-placeholders.html">3. Placeholders</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="04-snakemake_and_mpi.html">4. MPI applications and Snakemake</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="amdahl_foundation.html">5. Running a Parallel Application on the Cluster</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="snakemake_single.html">6. Introduction to Snakemake</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="snakemake_multiple.html">7. More Complicated Snakefiles</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush9">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading9">
        <a href="snakemake_cluster.html">8. Snakemake and the Cluster</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush10">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading10">
        <a href="snakemake_profiles.html">9. Snakemake Profiles</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush11">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading11">
        <a href="amdahl_snakemake.html">10. Amdahl Parallel Runs</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width">
<div class="accordion accordion-flush resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul>
<li>
                        <a href="key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="reference.html#glossary">Glossary</a>
                      </li>
                      <li>
                        <a href="profiles.html">Learner Profiles</a>
                      </li>
                      <li><a href="reference.html">Reference</a></li>
                    </ul>
</div>
                </div>
              </div>
            </div>
            <hr class="half-width resources">
<a href="aio.html">See all in one page</a>
            

            <hr class="d-none d-sm-block d-md-none">
<div class="d-grid gap-1">
            
            </div>
          </div>
<!-- /div.accordion -->
        </div>
<!-- /div.sidebar-inner -->
      </nav>
</div>
<!-- /div.sidebar -->
  </div>
<!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-extra.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <main id="main-content" class="main-content"><div class="container lesson-content">
        
        
<section id="aio-01-introduction"><p>Content from <a href="01-introduction.html">Running commands with Snakemake</a></p>
<hr>
<p>Last updated on 2024-01-30 |
        
        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/01-introduction.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“How do I run a simple command with Snakemake?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“Create a Snakemake recipe (a Snakefile)”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="what-is-the-workflow-im-interested-in"><h2 class="section-heading">What is the workflow I’m interested in?<a class="anchor" aria-label="anchor" href="#what-is-the-workflow-im-interested-in"></a>
</h2>
<hr class="half-width">
<p>In this lesson we will make an experiment that takes an application
which runs in parallel and investigate it’s scalability. To do that we
will need to gather data, in this case that means running the
application multiple times with different numbers of CPU cores and
recording the execution time. Once we’ve done that we need to create a
visualisation of the data to see how it compares against the ideal
case.</p>
<p>From the visualisation we can then decide at what scale it makes most
sense to run the application at in production to maximise the use of our
CPU allocation on the system.</p>
<p>We could do all of this manually, but there are useful tools to help
us manage data analysis pipelines like we have in our experiment. Today
we’ll learn about one of those: Snakemake.</p>
<p>In order to get started with Snakemake, let’s begin by taking a
simple command and see how we can run that via Snakemake. Let’s choose
the command <code>hostname</code> which prints out the name of the host
where the command is executed:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ hostname</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">node1.int.jetstream2.hpc</span><span class="op">-</span><span class="va">carpentry.org</span></span></code></pre>
</div>
<p>That prints out the result but Snakemake relies on files to know the
status of your workflow, so let’s redirect the output to a file:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ hostname <span class="op">&gt;</span> hostname_login.txt</span></code></pre>
</div>
</section><section id="making-a-snakefile"><h2 class="section-heading">Making a Snakefile<a class="anchor" aria-label="anchor" href="#making-a-snakefile"></a>
</h2>
<hr class="half-width">
<p>Edit a new text file named <code>Snakefile</code>.</p>
<p>Contents of <code>Snakefile</code>:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>rule hostname_login:</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    output: <span class="st">"hostname_login.txt"</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span>:  </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    shell:</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">"hostname &gt; hostname_login.txt"</span></span></code></pre>
</div>
<div id="key-points-about-this-file" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="key-points-about-this-file" class="callout-inner">
<h3 class="callout-title">Key points about this file<a class="anchor" aria-label="anchor" href="#key-points-about-this-file"></a>
</h3>
<div class="callout-content">
<ol style="list-style-type: decimal">
<li>The file is named <code>Snakefile</code> - with a capital
<code>S</code> and no file extension.</li>
<li>Some lines are indented. Indents must be with space characters, not
tabs. See the setup section for how to make your text editor do
this.</li>
<li>The rule definition starts with the keyword <code>rule</code>
followed by the rule name, then a colon.</li>
<li>We named the rule <code>hostname</code>. You may use letters,
numbers or underscores, but the rule name must begin with a letter and
may not be a keyword.</li>
<li>The keywords <code>input</code>, <code>output</code>,
<code>shell</code> are all followed by a colon.</li>
<li>The file names and the shell command are all in
<code>"quotes"</code>.</li>
<li>The output filename is given before the input filename. In fact,
Snakemake doesn’t care what order they appear in but we give the output
first throughout this course. We’ll see why soon.</li>
<li>In this use case there is no input file for the command so we leave
this blank.</li>
</ol>
</div>
</div>
</div>
<p>Back in the shell we’ll run our new rule. At this point, if there
were any missing quotes, bad indents, etc. we may see an error.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> snakemake <span class="at">-j1</span> <span class="at">-p</span> hostname_login.txt</span></code></pre>
</div>
<div id="bash-snakemake-command-not-found..." class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="bash-snakemake-command-not-found..." class="callout-inner">
<h3 class="callout-title">
<code>bash: snakemake: command not found...</code><a class="anchor" aria-label="anchor" href="#bash-snakemake-command-not-found..."></a>
</h3>
<div class="callout-content">
<p>If your shell tells you that it cannot find the command
<code>snakemake</code> then we need to make the software available
somehow. In our case, this means searching for the module that we need
to load:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> spider snakemake</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[ocaisa@node1 ~]$ module spider snakemake

--------------------------------------------------------------------------------------------------------
  snakemake:
--------------------------------------------------------------------------------------------------------
     Versions:
        snakemake/8.2.1-foss-2023a
        snakemake/8.2.1 (E)

Names marked by a trailing (E) are extensions provided by another module.


--------------------------------------------------------------------------------------------------------
  For detailed information about a specific "snakemake" package (including how to load the modules) use the module's full name.
  Note that names that have a trailing (E) are extensions provided by other modules.
  For example:

     $ module spider snakemake/8.2.1
--------------------------------------------------------------------------------------------------------
</code></pre>
</div>
<p>Now we want the module, so let’s load that to make the package
available</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ module load snakemake</span></code></pre>
</div>
<p>and then make sure we have the <code>snakemake</code> command
available</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ which snakemake</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>/cvmfs/software.eessi.io/host_injections/2023.06/software/linux/x86_64/amd/zen3/software/snakemake/8.2.1-foss-2023a/bin/snakemake</code></pre>
</div>
</div>
</div>
</div>
<div id="running-snakemake" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="running-snakemake" class="callout-inner">
<h3 class="callout-title">Running Snakemake<a class="anchor" aria-label="anchor" href="#running-snakemake"></a>
</h3>
<div class="callout-content">
<p>Run <code>snakemake --help | less</code> to see the help for all
available options. What does the <code>-p</code> option in the
<code>snakemake</code> command above do?</p>
<ol style="list-style-type: decimal">
<li>Protects existing output files</li>
<li>Prints the shell commands that are being run to the terminal</li>
<li>Tells Snakemake to only run one process at a time</li>
<li>Prompts the user for the correct input file</li>
</ol>
<p><em>Hint: you can search in the text by pressing <code>/</code>, and
quit back to the shell with <code>q</code></em></p>
<div class="Solution">
<ol start="2" style="list-style-type: decimal">
<li>Prints the shell commands that are being run to the terminal</li>
</ol>
<p>This is such a useful thing we don’t know why it isn’t the default!
The <code>-j1</code> option is what tells Snakemake to only run one
process at a time, and we’ll stick with this for now as it makes things
simpler. The <code>-F</code> option tells Snakemake to always overwrite
output files, and we’ll learn about protected outputs much later in the
course. Answer 4 is a total red-herring, as Snakemake never prompts
interactively for user input.</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>“Before running Snakemake you need to write a Snakefile”</li>
<li>“A Snakefile is a text file which defines a list of rules”</li>
<li>“Rules have inputs, outputs, and shell commands to be run”</li>
<li>“You tell Snakemake what file to make and it will run the shell
command defined in the appropriate rule”</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-02-snakemake_on_the_cluster"><p>Content from <a href="02-snakemake_on_the_cluster.html">Running Snakemake on the cluster</a></p>
<hr>
<p>Last updated on 2024-01-30 |
        
        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/02-snakemake_on_the_cluster.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“How do I run my Snakemake rule on the cluster?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“Define rules to run locally and on the cluster”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>What happens when we want to make our rule run on the cluster rather
than the login node? The cluster we are using uses Slurm, and it happens
that Snakemake has built in support for Slurm, we just need to tell it
that we want to use it.</p>
<p>Snakemake uses the <code>executor</code> option to allow you to
select the plugin that you wish to execute the rule. The quickest way to
apply this to your Snakefile is to define this on the command line.
Let’s try it out</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ snakemake <span class="at">-j1</span> <span class="at">-p</span> <span class="at">--executor</span> slurm hostname_login</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Building DAG of jobs...
Retrieving input from storage.
Nothing to be done (all requested files are present and up to date).</code></pre>
</div>
<p>Nothing happened! Why not? When it is asked to build a target,
Snakemake checks the ‘last modification time’ of both the target and its
dependencies. If any dependency has been updated since the target, then
the actions are re-run to update the target. Using this approach,
Snakemake knows to only rebuild the files that, either directly or
indirectly, depend on the file that changed. This is called an
<em>incremental build]</em>.</p>
<div id="incremental-builds-improve-efficiency" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="incremental-builds-improve-efficiency" class="callout-inner">
<h3 class="callout-title">Incremental Builds Improve Efficiency<a class="anchor" aria-label="anchor" href="#incremental-builds-improve-efficiency"></a>
</h3>
<div class="callout-content">
<p>By only rebuilding files when required, Snakemake makes your
processing more efficient.</p>
</div>
</div>
</div>
<div id="running-on-the-cluster" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="running-on-the-cluster" class="callout-inner">
<h3 class="callout-title">Running on the cluster<a class="anchor" aria-label="anchor" href="#running-on-the-cluster"></a>
</h3>
<div class="callout-content">
<p>We need another rule now that executes the <code>hostname</code> on
the cluster. Create the rule in your Snakefile and try to execute it on
cluster with the options <code>--executor slurm</code> to
<code>snakemake</code></p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">Show me the solution</h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>The rule is almost identical to the previous rule save for the rule
name and output file:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>rule hostname_remote:</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    output: <span class="st">"hostname_remote.txt"</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    shell:</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">"hostname &gt; hostname_remote.txt"</span></span></code></pre>
</div>
<p>You can then execute the rule with</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ snakemake <span class="at">-j1</span> <span class="at">-p</span> <span class="at">--executor</span> slurm hostname_remote</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Building DAG of jobs...
Retrieving input from storage.
Using shell: /cvmfs/software.eessi.io/versions/2023.06/compat/linux/x86_64/bin/bash
Provided remote nodes: 1
Job stats:
job                count
---------------  -------
hostname_remote        1
total                  1

Select jobs to execute...
Execute 1 jobs...

[Mon Jan 29 18:03:46 2024]
rule hostname_remote:
    output: hostname_remote.txt
    jobid: 0
    reason: Missing output files: hostname_remote.txt
    resources: tmpdir=&lt;TBD&gt;

hostname &gt; hostname_remote.txt
No SLURM account given, trying to guess.
Guessed SLURM account: def-users
No wall time information given. This might or might not work on your cluster. If not, specify the resource runtime in your rule or as a reasonable default via --default-resources.
No job memory information ('mem_mb' or 'mem_mb_per_cpu') is given - submitting without. This might or might not work on your cluster.
Job 0 has been submitted with SLURM jobid 326 (log: /home/ocaisa/.snakemake/slurm_logs/rule_hostname_remote/326.log).
[Mon Jan 29 18:04:26 2024]
Finished job 0.
1 of 1 steps (100%) done
Complete log: .snakemake/log/2024-01-29T180346.788174.snakemake.log</code></pre>
</div>
<p>Note all the warnings that Snakemake is giving us about the fact that
the rule may not be able to execute on our cluster as we may not have
given enough information. Luckily for us, this actually works on our
cluster and we can take a look in the output file we asked for,
<code>hostname_remote.txt</code>:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ cat hostname_remote.txt</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">tmpnode1.int.jetstream2.hpc</span><span class="op">-</span><span class="va">carpentry.org</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<section id="snakemake-profile"><h2 class="section-heading">Snakemake profile<a class="anchor" aria-label="anchor" href="#snakemake-profile"></a>
</h2>
<hr class="half-width">
<p>Adapting Snakemake to a particular environment can entail many flags
and options. Therefore, it is possible to specify a configuration
profile to be used to obtain default options. This looks like</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> myprofileFolder ...</span></code></pre>
</div>
<p>The profile folder must contain a file called
<code>config.yaml</code> which is what will store our options. The
folder may also contain other files necessary for the profile. Let’s
create the file <code>cluster_profile/config.yaml</code> and insert some
of our existing options:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">printshellcmds</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">executor</span><span class="kw">:</span><span class="at"> slurm</span></span></code></pre>
</div>
<p>We should now be able rerun our workflow by pointing to the profile
rather than the listing out the options. To force our workflow to rerun,
we first need to remove the output file
<code>hostname_remote.txt</code>, and then we can try out our new
profile</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ rm hostname_remote.txt </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ snakemake <span class="at">--profile</span> cluster_profile hostname_remote</span></code></pre>
</div>
<p>The profile is extremely useful in the context of our cluster, as the
Slurm executor has lots of options, and sometimes you need to use them
to be able to submit jobs to the cluster you have access to.
Unfortunately, the names of the options in Snakemake are not
<em>exactly</em> the same as those of Slurm, so we need the help of a
translation table:</p>
<table class="table">
<colgroup>
<col width="18%">
<col width="18%">
<col width="62%">
</colgroup>
<thead><tr class="header">
<th>SLURM</th>
<th>Snakemake</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>--partition</code></td>
<td><code>slurm_partition</code></td>
<td>the partition a rule/job is to use</td>
</tr>
<tr class="even">
<td><code>--time</code></td>
<td><code>runtime</code></td>
<td>the walltime per job in minutes</td>
</tr>
<tr class="odd">
<td><code>--constraint</code></td>
<td><code>constraint</code></td>
<td>may hold features on some clusters</td>
</tr>
<tr class="even">
<td><code>--mem</code></td>
<td><code>mem, mem_mb</code></td>
<td>memory a cluster node must</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>provide (mem: string with unit), mem_mb: int</td>
</tr>
<tr class="even">
<td><code>--mem-per-cpu</code></td>
<td><code>mem_mb_per_cpu</code></td>
<td>memory per reserved CPU</td>
</tr>
<tr class="odd">
<td><code>--ntasks</code></td>
<td><code>tasks</code></td>
<td>number of concurrent tasks / ranks</td>
</tr>
<tr class="even">
<td><code>--cpus-per-task</code></td>
<td><code>cpus_per_task</code></td>
<td>number of cpus per task (in case of SMP, rather use
<code>threads</code>)</td>
</tr>
<tr class="odd">
<td><code>--nodes</code></td>
<td><code>nodes</code></td>
<td>number of nodes</td>
</tr>
</tbody>
</table>
<p>The warnings given by Snakemake hinted that we need to provide these
options. One way to do it is to provide them is as part of the Snakemake
rule, e.g.,</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>rule:</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span>: ...</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    output: ...</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    resources:</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        partition: <span class="op">&lt;</span>partition name<span class="op">&gt;</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        runtime: <span class="op">&lt;</span>some number<span class="op">&gt;</span></span></code></pre>
</div>
<p>and we can also use the profile to define default values for these
options to use with our project. For example, the available memory on
our cluster is about 4GB per core, so we can add that to our
profile:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">printshellcmds</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">executor</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">default-resources</span><span class="kw">:</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> mem_mb_per_cpu=3600</span></span></code></pre>
</div>
<div id="discussion1" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#discussion1"></a>
</h3>
<div class="callout-content">
<p>We know that our problem runs in a very short time. Make the default
length of our jobs to two minutes for Slurm. ::::::solution</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">printshellcmds</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">executor</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="fu">default-resources</span><span class="kw">:</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> mem_mb_per_cpu=3600</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> runtime=2</span></span></code></pre>
</div>
</div>
</div>
</div>
<p>:::</p>
<p>There are various <code>sbatch</code> options not directly supported
by the resource definitions in the table above. You may use the
<code>slurm_extra</code> resource to specify any of these additional
flags to <code>sbatch</code>:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>rule myrule:</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span>: ...</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    output: ...</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    resources:</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>        slurm_extra<span class="op">=</span><span class="st">"--mail-type=ALL --mail-user=&lt;your email&gt;"</span></span></code></pre>
</div>
</section><section id="local-rule-execution"><h2 class="section-heading">Local rule execution<a class="anchor" aria-label="anchor" href="#local-rule-execution"></a>
</h2>
<hr class="half-width">
<p>Our initial rule was to get the hostname of the login node. We always
want to run that rule on the login node for that to make sense. If we
tell Snakemake to run all rules via the Slurm executor (which is what we
are doing via our new profile) this won’t happen any more. So how do we
force the rule to run on the login node?</p>
<p>Well, it’s no surprise that some Snakemake rules perform trivial
tasks where job submission might be overkill (e.g., less than 1 minute
worth of compute time). Similar to our case, it would be a better idea
to have these rules execute locally (i.e. where the
<code>snakemake</code> command is run) instead of as a job. Snakemake
lets you indicate which rules should always run locally with the
<code>localrules</code> keyword. Let’s define
<code>hostname_login</code> as a local rule near the top of our
<code>Snakefile</code>.</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>localrules: hostname_login</span></code></pre>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>“Snakemake generates and submits its own batch scripts for your
scheduler.”</li>
<li>“You can store default configuration settings in a Snakemake
profile”</li>
<li>“<code>localrules</code> defines rules that are executed locally,
and never submitted to a cluster.”</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-03-placeholders"><p>Content from <a href="03-placeholders.html">Placeholders</a></p>
<hr>
<p>Last updated on 2024-01-30 |
        
        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/03-placeholders.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“How do I make a generic rule?”</li>
<li>“How does Snakemake decide what rule to run?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“Understand the basic steps Snakemake goes through when running a
workflow”</li>
<li>“See how Snakemake deals with some errors”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>Our Snakefile has some duplication. For example, the names of text
files are repeated in places throughout the Snakefile rules. Snakefiles
are a form of code and, in any code, repetition can lead to problems
(e.g. we rename a data file in one part of the Snakefile but forget to
rename it elsewhere).</p>
<div id="d.r.y.-dont-repeat-yourself" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="d.r.y.-dont-repeat-yourself" class="callout-inner">
<h3 class="callout-title">D.R.Y. (Don’t Repeat Yourself)<a class="anchor" aria-label="anchor" href="#d.r.y.-dont-repeat-yourself"></a>
</h3>
<div class="callout-content">
<p>In many programming languages, the bulk of the language features are
there to allow the programmer to describe long-winded computational
routines as short, expressive, beautiful code. Features in Python, R, or
Java, such as user-defined variables and functions are useful in part
because they mean we don’t have to write out (or think about) all of the
details over and over again. This good habit of writing things out only
once is known as the “Don’t Repeat Yourself” principle or D.R.Y.</p>
</div>
</div>
</div>
<p>Let us set about removing some of the repetition from our
Snakefile.</p>
<section id="placeholders"><h2 class="section-heading">Placeholders<a class="anchor" aria-label="anchor" href="#placeholders"></a>
</h2>
<hr class="half-width">
<p>To make a more general-purpose rule we need
<strong>placeholders</strong>. Let’s take a look at what a placeholder
looks like</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>rule hostname_remote:</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    output: <span class="st">"hostname_remote.txt"</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    shell:</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">"hostname &gt; {output}"</span></span></code></pre>
</div>
<p>As a reminder, here’s the previous version from the last episode:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>rule hostname_remote:</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    output: <span class="st">"hostname_remote.txt"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    shell:</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">"hostname &gt; hostname_remote.txt"</span></span></code></pre>
</div>
<p>The new rule has replaced explicit file names with things in
<code>{curly brackets}</code>, specifically <code>{output}</code> (but
it could also have been <code>{input}</code>…if that had a value and
were useful).</p>
<div class="section level3">
<h3 id="input-and-output-are-placeholders">
<code>{input}</code> and <code>{output}</code> are
<strong>placeholders</strong>
<a class="anchor" aria-label="anchor" href="#input-and-output-are-placeholders"></a>
</h3>
<p>Placeholders are used in the <code>shell</code> section of a rule,
and Snakemake will replace them with appropriate values -
<code>{input}</code> with the full name of the input file, and
<code>{output}</code> with the full name of the output file – before
running the command.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>“Snakemake rules are made more generic with placeholders”</li>
<li>“Placeholders in the shell part of the rule are replaced with values
based on the chosen wildcards”</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</div>
</section></section><section id="aio-04-snakemake_and_mpi"><p>Content from <a href="04-snakemake_and_mpi.html">MPI applications and Snakemake</a></p>
<hr>
<p>Last updated on 2024-01-30 |
        
        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/04-snakemake_and_mpi.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“How do I run an MPI application via Snakemake on the cluster?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“Define rules to run locally and on the cluster”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>Now it’s time to start getting back to our real workflow. We can
execute a command on the cluster, but what about executing the MPI
application we are interested in? Our application is called
<code>amdahl</code> and is available as an environment module.</p>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge1"></a>
</h3>
<div class="callout-content">
<p>Locate and load the <code>amdahl</code> module and then replace our
<code>hostname_remote</code> rule with a version that runs
<code>amdahl</code>. (Don’t worry about parallel MPI just yet, run it
with a single CPU, <code>mpirun -n 1 amdahl</code>).</p>
<p>Does your rule execute correctly? If not look through the log files
to find out why?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">Show me the solution</h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> spider amdahl</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load amdahl</span></code></pre>
</div>
<p>will locate and then load the <code>amdahl</code> module. We can then
update/replace our rule to run the <code>amdahl</code> application:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    output: <span class="st">"amdahl_run.txt"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    shell:</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">"amdahl &gt; amdahl_run.txt"</span></span></code></pre>
</div>
<p>However, when we try to execute the rule we get an error (unless you
already have a different version of <code>amdahl</code> already
available in your path). Snakemake reports the location of the logs and
if we look inside we can (eventually) find</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>...
amdahl &gt; amdahl_run.txt
/cvmfs/software.eessi.io/versions/2023.06/compat/linux/x86_64/bin/bash: line 1: amdahl: command not found
...</code></pre>
</div>
<p>So, even though we loaded the module before running the workflow, our
Snakemake rule didn’t find the executable. That’s because the Snakemake
rule is running in a clean runtime environment, and we need to somehow
tell it to load the necessary environment module before trying to
execute the rule.</p>
</div>
</div>
</div>
</div>
<section id="snakemake-and-environment-modules"><h2 class="section-heading">Snakemake and environment modules<a class="anchor" aria-label="anchor" href="#snakemake-and-environment-modules"></a>
</h2>
<hr class="half-width">
<p>Our application is called <code>amdahl</code> and is available on the
system via an environment module, so we need to tell Snakemake to load
the module before it tries to execute the rule. Snakemake is aware of
environment modules, and these can be specified via (yet another)
option:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    output: <span class="st">"amdahl_run.txt"</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    envmodules:</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>      <span class="co">"mpi4py"</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    shell:</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">"mpiexec -n 1 {executable} &gt; {output}"</span></span></code></pre>
</div>
<p>Adding these lines are not enough to make the rule execute however.
Not only do you have to tell Snakemake what modules to load, but you
also have to tell it to use environment modules in general (since the
use of environment modules is considered to make your runtime
environment less reproducible as the available modules may differ from
cluster to cluster). This require you to give Snakemake an additonal
option</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile <span class="at">--use-envmodules</span> amdahl_run</span></code></pre>
</div>
<div id="challenge2" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge2"></a>
</h3>
<div class="callout-content">
<p>We’ll be using environment modules throughout the rest of tutorial,
so make that a default option of our profile (by setting it’s value to
<code>True</code>)</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">Show me the solution</h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<p>Update our cluster profile to</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">printshellcmds</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">executor</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">default-resources</span><span class="kw">:</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> mem_mb_per_cpu=3600</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> runtime=2</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="fu">use-envmodules</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span></code></pre>
</div>
<p>If you want to test it, you need to erase the output file of the rule
and rerun Snakemake.</p>
</div>
</div>
</div>
</div>
</section><section id="snakemake-and-mpi"><h2 class="section-heading">Snakemake and MPI<a class="anchor" aria-label="anchor" href="#snakemake-and-mpi"></a>
</h2>
<hr class="half-width">
<p>We didn’t really run an MPI application in the last section as we
only ran on one core. How do we request to run on multiple cores for a
single rule?</p>
<p>Snakemake has general support for MPI, but the only executor that
currently explicitly supports MPI is the Slurm executor (lucky for us!).
If we look back at our Slurm to Snakemake translation table we notice
the relevant options appear near the bottom:</p>
<table class="table">
<colgroup>
<col width="18%">
<col width="18%">
<col width="62%">
</colgroup>
<thead><tr class="header">
<th>SLURM</th>
<th>Snakemake</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr class="even">
<td><code>--ntasks</code></td>
<td><code>tasks</code></td>
<td>number of concurrent tasks / ranks</td>
</tr>
<tr class="odd">
<td><code>--cpus-per-task</code></td>
<td><code>cpus_per_task</code></td>
<td>number of cpus per task (in case of SMP, rather use
<code>threads</code>)</td>
</tr>
<tr class="even">
<td><code>--nodes</code></td>
<td><code>nodes</code></td>
<td>number of nodes</td>
</tr>
</tbody>
</table>
<p>The one we are interested is <code>tasks</code> as we are only going
to increase the number of ranks. We can define these in a
<code>resources</code> section of our rule and refer to them using
placeholders:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    output: <span class="st">"amdahl_run.txt"</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    envmodules:</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    resources:</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>      mpi<span class="op">=</span><span class="st">'mpiexec'</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>      tasks<span class="op">=</span><span class="dv">2</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    shell:</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">"{resources.mpi} -n {resources.tasks} amdahl &gt; {output}"</span></span></code></pre>
</div>
<p>That worked but now we have a bit of an issue. We want to do this for
a few different values of <code>tasks</code> that would mean we would
need a different output file for every run. It would be great if we can
somehow indicate in the <code>output</code> the value that we want to
use for <code>tasks</code>…and have Snakemake pick that up.</p>
<p>We could use a <em>wildcard</em> in the <code>output</code> to allow
us to define <code>tasks</code> we wish to use. The syntax for such a
wildcard looks like</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>output: <span class="st">"amdahl_run_</span><span class="sc">{parallel_tasks}</span><span class="st">.txt"</span></span></code></pre>
</div>
<p>where <code>parallel_tasks</code> is our wildcard.</p>
<div id="wildcards" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="wildcards" class="callout-inner">
<h3 class="callout-title">Wildcards<a class="anchor" aria-label="anchor" href="#wildcards"></a>
</h3>
<div class="callout-content">
<p>Wildcards are used in the <code>input</code> and <code>output</code>
lines of the rule to represent parts of filenames. Much like the
<code>*</code> pattern in the shell, the wildcard can stand in for any
text in order to make up the desired filename. As with naming your
rules, you may choose any name you like for your wildcards, so here we
used <code>parallel_tasks</code>. Using the same wildcards in the input
and output is what tells Snakemake how to match input files to output
files.</p>
<p>If two rules use a wildcard with the same name then Snakemake will
treat them as different entities - rules in Snakemake are self-contained
in this way.</p>
<p>In the <code>shell</code> line you can reference the wildcard with
<code>{wildcards.parallel_tasks}</code></p>
</div>
</div>
</div>
<p>We could use a wildcard in the <code>output</code> to allow us to
define <code>tasks</code> we wish to use. This could look like</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    output: <span class="st">"amdahl_run_</span><span class="sc">{parallel_tasks}</span><span class="st">.txt"</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    envmodules:</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    resources:</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>      mpi<span class="op">=</span><span class="st">"mpiexec"</span>,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>      tasks<span class="op">=</span><span class="st">"</span><span class="sc">{parallel_tasks}</span><span class="st">"</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    shell:</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">"{resources.mpi} -n {resources.tasks} amdahl &gt; {output}"</span></span></code></pre>
</div>
<p>but there are two problems with this:</p>
<ul>
<li>
<p>The only way for Snakemake to know the value of the wildcard is
for the user to explicitly request a concrete output file:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile amdahl_run_2.txt</span></code></pre>
</div>
</li>
<li>
<p>The bigger problem is that even doing that does not work, it
seems we cannot use a wildcard for <code>tasks</code>:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>WorkflowError:
SLURM job submission failed. The error message was sbatch: error: Invalid numeric value "{parallel_tasks}" for --ntasks.</code></pre>
</div>
</li>
</ul>
<p>Unfortunately there is no direct way for us to access the wildcards
in this scenario. The only way to do it is to <em>indirectly</em> access
the wildcards by using a function. The solution for this is to write a
one-time use function that has no name. Such functions are called either
anonymous functions or lamdba functions (both mean the same thing).</p>
<p>To define a lambda function in python, the general syntax is as
follows:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">lambda</span> x: x <span class="op">+</span> <span class="dv">54</span></span></code></pre>
</div>
<p>Since a function <em>can</em> see the wildcards, we can use that to
set the value for <code>tasks</code>:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    output: <span class="st">"amdahl_run_</span><span class="sc">{parallel_tasks}</span><span class="st">.txt"</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    envmodules:</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    resources:</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>      mpi<span class="op">=</span><span class="st">"mpiexec"</span>,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>      <span class="co"># No direct way to access the wildcard in tasks, so we need to do this</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>      <span class="co"># indirectly by declaring a short function that takes the wildcards as an</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>      <span class="co"># argument</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>      tasks<span class="op">=</span><span class="kw">lambda</span> wildcards: <span class="bu">int</span>(wildcards.parallel_tasks)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    shell:</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">"{resources.mpi} -n {resources.tasks} amdahl &gt; {output}"</span></span></code></pre>
</div>
<p>Now we have a rule that can be used to generate output from runs of
an arbitrary number of parallel tasks.</p>
<div id="comments-in-snakefiles" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="comments-in-snakefiles" class="callout-inner">
<h3 class="callout-title">Comments in Snakefiles<a class="anchor" aria-label="anchor" href="#comments-in-snakefiles"></a>
</h3>
<div class="callout-content">
<p>In the above code, the line beginning <code>#</code> is a comment
line. Hopefully you are already in the habit of adding comments to your
own scripts. Good comments make any script more readable, and this is
just as true with Snakefiles.</p>
</div>
</div>
</div>
<div id="challenge3" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge3"></a>
</h3>
<div class="callout-content">
<p>Create an output file for the case where we have 6 parallel tasks</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3">Show me the solution</h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" aria-labelledby="headingSolution3" data-bs-parent="#accordionSolution3">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile amdahl_run_6.txt</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section id="snakemake-order-of-operations"><h2 class="section-heading">Snakemake order of operations<a class="anchor" aria-label="anchor" href="#snakemake-order-of-operations"></a>
</h2>
<hr class="half-width">
<p>We’re only just getting started with some simple rules, but it’s
worth thinking about exactly what Snakemake is doing when you run it.
There are three distinct phases:</p>
<ol style="list-style-type: decimal">
<li>Prepares to run:
<ol style="list-style-type: decimal">
<li>Reads in all the rule definitions from the Snakefile</li>
</ol>
</li>
<li>Plans what to do:
<ol style="list-style-type: decimal">
<li>Sees what file(s) you are asking it to make</li>
<li>Looks for a matching rule by looking at the <code>output</code>s of
all the rules it knows</li>
<li>Fills in the wildcards to work out the <code>input</code> for this
rule</li>
<li>Checks that this input file (if required) is actually available</li>
</ol>
</li>
<li>Runs the steps:
<ol style="list-style-type: decimal">
<li>Creates the directory for the output file, if needed</li>
<li>Removes the old output file if it is already there</li>
<li>Only then, runs the shell command with the placeholders
replaced</li>
<li>Checks that the command ran without errors <em>and</em> made the new
output file as expected</li>
</ol>
</li>
</ol>
<div id="dry-run--n-mode" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="dry-run--n-mode" class="callout-inner">
<h3 class="callout-title">Dry-run (-n) mode<a class="anchor" aria-label="anchor" href="#dry-run--n-mode"></a>
</h3>
<div class="callout-content">
<p>It’s often useful to run just the first two phases, so that Snakemake
will plan out the jobs to run, and print them to the screen, but never
actually run them. This is done with the <code>-n</code> flag, eg:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> $ <span class="ex">snakemake</span> <span class="at">-n</span> ...</span></code></pre>
</div>
</div>
</div>
</div>
<p>The amount of checking may seem pedantic right now, but as the
workflow gains more steps this will become very useful to us indeed.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>“Snakemake chooses the appropriate rule by replacing wildcards such
that the output matches the target”</li>
<li>“Snakemake checks for various error conditions and will stop if it
sees a problem”</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-amdahl_foundation"><p>Content from <a href="amdahl_foundation.html">Running a Parallel Application on the Cluster</a></p>
<hr>
<p>Last updated on 2024-01-30 |
        
        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/amdahl_foundation.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What output does the Amdahl code generate?</li>
<li>Why does parallelizing the amdahl code make it faster?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Run the amdahl parallel code on the cluster</li>
<li>Note what output is generated, and where it goes</li>
<li>Predict the trend of execution time vs parallelism</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="introduction"><h2 class="section-heading">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<hr class="half-width">
<p>A high-performance computing cluster offers powerful computational
resources to its users, but taking advantage of these resources is not
always straightforward. The cluster system does not work in the same way
as systems you may be more familiar with.</p>
<p>The software we will use in this lesson is a model of the kind of
parallel task that is well-adapted to high-performance computing
resources. It’s called “amdahl”, named for Eugene Amdahl, a famous
computer scientist who coined “Amdahl’s Law”, which is about the
advantages and limitations of parallelism in code execution.</p>
<div id="callout1" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout<a class="anchor" aria-label="anchor" href="#callout1"></a>
</h3>
<div class="callout-content">
<p><a href="https://en.wikipedia.org/wiki/Amdahl%27s_law" class="external-link">Amdahl’s
Law</a> is a statement about how much benefit you can expect to get by
parallelizing a computer program.</p>
<p>The limitation arises from the fact that, in any application, there
is some fraction of the work to be done which is inherently serial, and
some fraction which is amenable to parallelization. The law is a
quantitative expression of the fact that, by parallelizing the code, you
can only ever make the parallel part faster, you cannot reduce the
execution time of the serial part.</p>
<p>As a practical matter, this means that developer effort spent on
parallelization has diminishing returns on the overall reduction in
execution time.</p>
</div>
</div>
</div>
</section><section id="the-amdahl-code"><h2 class="section-heading">The Amdahl Code<a class="anchor" aria-label="anchor" href="#the-amdahl-code"></a>
</h2>
<hr class="half-width">
<p>Download it and install it, via pip. Note that <code>amdahl</code>
depends on MPI, so make sure that’s also available.</p>
<p>On the HPC Carpentry cluster:</p>
<pre class="shell"><code>[user@login1 ~]$ module load OpenMPI
[user@login1 ~]$ module load Python
[user@login1 ~]$ pip install amdahl</code></pre>
</section><section id="running-it-on-the-cluster"><h2 class="section-heading">Running It on the Cluster<a class="anchor" aria-label="anchor" href="#running-it-on-the-cluster"></a>
</h2>
<hr class="half-width">
<p>Use the <code>sacct</code> command to see the run-time. The run-time
is also recorded in the output itself.</p>
<pre class="shell"><code>[user@login1 ~]$ nano amdahl_1.sh</code></pre>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH -t 00:01          # max 1 minute</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH -p smnodes        # max 4 cores</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH -n 1              # use 1 core</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH -o amdahl-np1.out # record result</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load OpenMPI</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load Python</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="ex">mpirun</span> amdahl</span></code></pre>
</div>
<pre class="shell"><code>[user@login1 ~]$ sbatch amdahl_1.sh</code></pre>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge1"></a>
</h3>
<div class="callout-content">
<p>Run the amdhal code with a few (small!) levels of parallelism. Make a
quantitative estimate of how much faster the code will run with 3
processors than 2. The naive estimate would be that it would run 1.5×
the speed, or equivalently, that it would complete in 2/3 the time.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">Show me the solution</h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<pre class="shell"><code>[user@login1 ~]$ sbatch amdahl_1.sh  # serial job     ~ 25 sec
[user@login1 ~]$ sbatch amdahl_2.sh  # 2-way parallel ~ 20 sec
[user@login1 ~]$ sbatch amdahl_3.sh  # 3-way parallel ~ 16 sec</code></pre>
<p>The amdahl code runs faster with 3 processors than with 2, but the
speed-up is less than 1.5×.</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>The amdahl code is a model of a parallel application</li>
<li>The execution speed depends on the degree of parallelism</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-snakemake_single"><p>Content from <a href="snakemake_single.html">Introduction to Snakemake</a></p>
<hr>
<p>Last updated on 2024-01-30 |
        
        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/snakemake_single.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What are Snakemake rules?</li>
<li>Why do Snakemake rules not always run?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Write a single-rule Snakefile and execute it with Snakemake</li>
<li>Predict whether the rule will run or not</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="snakemake"><h2 class="section-heading">Snakemake<a class="anchor" aria-label="anchor" href="#snakemake"></a>
</h2>
<hr class="half-width">
<p>Snakemake is a workflow tool. It takes as input a description of the
work that you would like the computer to do, and when run, does the work
that you have asked for.</p>
<p>The description of the work takes the form of a series of rules,
written in a special format into a Snakefile. Rules have outputs, and
the Snakefile and generated output files make up the system state.</p>
</section><section id="write-a-snakemake-rule-file"><h2 class="section-heading">Write a Snakemake rule file<a class="anchor" aria-label="anchor" href="#write-a-snakemake-rule-file"></a>
</h2>
<hr class="half-width">
<p>Open your favorite editor, do the thing.</p>
</section><section id="run-snakemake"><h2 class="section-heading">Run Snakemake<a class="anchor" aria-label="anchor" href="#run-snakemake"></a>
</h2>
<hr class="half-width">
<p>Throw the switch!</p>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge1"></a>
</h3>
<div class="callout-content">
<p>Remove the output file, and run Snakemake. Then run it again. Edit
the output file, and run it a third time. For which of these invocations
does Snakemake do non-trivial work?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">Show me the solution</h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>The rule does not get executed the second time. The Snakemake
infrastructure is stateful, and knows that the required outputs are up
to date.</p>
<p>The rule also does not get executed the third time. The output is not
the output from the rule, but the Snakemake infrastructure doesn’t know
that, it only checks the file time-stamp. Editing Snakemake-manipulated
files can get you into an inconsistent state.</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Snakemake is an indirect way of running executables</li>
<li>Snakemake has a notion of system state, and can be fooled.</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-snakemake_multiple"><p>Content from <a href="snakemake_multiple.html">More Complicated Snakefiles</a></p>
<hr>
<p>Last updated on 2024-01-30 |
        
        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/snakemake_multiple.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What is a task graph?</li>
<li>How does the Snakemake file express a task graph?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Write a multiple-rule Snakefile with dependent rules</li>
<li>Translate between a task graph and rule set</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="snakemake-and-workflow"><h2 class="section-heading">Snakemake and Workflow<a class="anchor" aria-label="anchor" href="#snakemake-and-workflow"></a>
</h2>
<hr class="half-width">
<p>A Snakefile can contain multiple rules. In the trivial case, there
will be no dependencies between the rules, and they can all run
concurrently.</p>
<p>A more interesting case is when there are dependencies between the
rules, e.g. when one rule takes the output of another rule as its input.
In this case, the dependent rule (the one that needs another rule’s
output) cannot run until the rule it depends on has completed.</p>
<p>It’s possible to express this relationship by means of a task graph,
whose nodes are tasks, and whose arcs are input-output relationships
between the tasks.</p>
<p>A Snakemake file is textual description of a task graph.</p>
</section><section id="write-a-multi-rule-snakemake-rule-file"><h2 class="section-heading">Write a multi-rule Snakemake rule file<a class="anchor" aria-label="anchor" href="#write-a-multi-rule-snakemake-rule-file"></a>
</h2>
<hr class="half-width">
<p>Open your favorite editor, do the thing.</p>
</section><section id="run-snakemake"><h2 class="section-heading">Run Snakemake<a class="anchor" aria-label="anchor" href="#run-snakemake"></a>
</h2>
<hr class="half-width">
<p>Throw the switch!</p>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge1"></a>
</h3>
<div class="callout-content">
<p>Draw the task graph for your Snakefile.</p>
<p>Given an example task graph, write a Snakefile that implements
it.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">Show me the solution</h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>The rules in the snakefile are nodes in the task graph. Two rules are
connected by an arc in the task graph if the output of one rule is the
input to the other. The task graph is directed, so the arc points from
the rule that generates a file as output to the rule that consumes the
same file as input.</p>
<p>A rule with an output that no other rules consumes is a terminal
rule.</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Snakemake rule files can be mapped to task graphs</li>
<li>Tasks are executed as required in dependency order</li>
<li>Where possible, tasks may run concurrently.</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-snakemake_cluster"><p>Content from <a href="snakemake_cluster.html">Snakemake and the Cluster</a></p>
<hr>
<p>Last updated on 2024-01-30 |
        
        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/snakemake_cluster.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can we express a one-task cluster operation in Snakemake?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Write a Snakefile that executes a job on the cluster</li>
<li>Use MPI options to ensure the job runs in parallel</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="snakemake-and-the-cluster"><h2 class="section-heading">Snakemake and the Cluster<a class="anchor" aria-label="anchor" href="#snakemake-and-the-cluster"></a>
</h2>
<hr class="half-width">
<p>Snakemake has provisions for operating on an HPC cluster.</p>
<p>Various command-line arguments can be provided to tell Snakemake not
to run things locally, but do run things via the queuing system
instead.</p>
<p>In this lesson, we will repeat the first module, running the admahl
code on the cluster, but will use snakemake to make it happen.</p>
</section><section id="write-a-cluster-snakemake-rule-file"><h2 class="section-heading">Write a cluster Snakemake rule file<a class="anchor" aria-label="anchor" href="#write-a-cluster-snakemake-rule-file"></a>
</h2>
<hr class="half-width">
<p>Open your favorite editor, do the thing. Specify resources. Provide
command line arguments to do the cluster operations by hand.</p>
</section><section id="run-snakemake"><h2 class="section-heading">Run Snakemake<a class="anchor" aria-label="anchor" href="#run-snakemake"></a>
</h2>
<hr class="half-width">
<p>Throw the switch!</p>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge1"></a>
</h3>
<div class="callout-content">
<p>How can you control the degree of parallelism of your cluster
task?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">Show me the solution</h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>Use the “mpi” option in the resource block of the Snakemake rule, and
specify the number of tasks. This will be mapped to the <code>-n</code>
argument of the equivalent <code>sbatch</code> command.</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Snakemake rule files can submit cluster jobs.</li>
<li>There are a lot of options.</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-snakemake_profiles"><p>Content from <a href="snakemake_profiles.html">Snakemake Profiles</a></p>
<hr>
<p>Last updated on 2024-01-30 |
        
        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/snakemake_profiles.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can we encapsulate our desired snakemake configuration?</li>
<li>How do we balance non-reptition and customizability?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Write a Snakemake profile for the cluster</li>
<li>Run the amdahl code with varying degrees of parallelism with the
cluster profile.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="snakemake-profiles"><h2 class="section-heading">Snakemake Profiles<a class="anchor" aria-label="anchor" href="#snakemake-profiles"></a>
</h2>
<hr class="half-width">
<p>Snakemake has a provision for profiles, which allow users to collect
various common settings together in a special file that snakemake
examines when it runs. This lets users avoid repetition and possible
errors of omission for common settings, and encapsulates some of the
cluster complexity we encoutered in the previous module.</p>
<p>Not all settings should be in the profile. Users can choose which
ones to make static and which ones to make adjustable. In our case, we
will want to have the freedom to choose the degree of parallelism, but
most of the cluster arguments will not change, and so can be static in
the profile.</p>
</section><section id="write-a-profile"><h2 class="section-heading">Write a Profile<a class="anchor" aria-label="anchor" href="#write-a-profile"></a>
</h2>
<hr class="half-width">
<p>Do the thing.</p>
</section><section id="run-snakemake"><h2 class="section-heading">Run Snakemake<a class="anchor" aria-label="anchor" href="#run-snakemake"></a>
</h2>
<hr class="half-width">
<p>Throw the switch!</p>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge1"></a>
</h3>
<div class="callout-content">
<p>Write a profile that allows you to choose a different partition, in
addition to the level of parallelism.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">Show me the solution</h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>The profile files can have variables taken from the rule file, and in
particular can refer to resources from a rule.</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Snakemake profiles encapsulate cluster complexity.</li>
<li>Retaining operational flexibliity is also important.</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-amdahl_snakemake"><p>Content from <a href="amdahl_snakemake.html">Amdahl Parallel Runs</a></p>
<hr>
<p>Last updated on 2024-01-30 |
        
        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/amdahl_snakemake.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can we collect data on Amdahl run times?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Collect systematic data on the runtime of the amdahl code</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="systematic-data-collection"><h2 class="section-heading">Systematic Data Collection<a class="anchor" aria-label="anchor" href="#systematic-data-collection"></a>
</h2>
<hr class="half-width">
<p>Using what we have learned so far, including Snakemake profiles and
rules, we will now compose a Snakefile that runs the Amdahl example code
over a range of parallel widths. This workflow will generate the data we
will use in the next module to demonstrate the diminishing returns of
increasing parallelism.</p>
</section><section id="write-a-file"><h2 class="section-heading">Write a File<a class="anchor" aria-label="anchor" href="#write-a-file"></a>
</h2>
<hr class="half-width">
<p>Compose the Snakemake file that does what we want.</p>
<p>We can put the widths in a list and iterate over them. We will use
the profile generated previously to ensure that the jobs run on the
cluster.</p>
</section><section id="run-snakemake"><h2 class="section-heading">Run Snakemake<a class="anchor" aria-label="anchor" href="#run-snakemake"></a>
</h2>
<hr class="half-width">
<p>Throw the switch!</p>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge1"></a>
</h3>
<div class="callout-content">
<p>Our example has a single paramter, the parallelism, that we vary. How
would you generalize this to arbitrary parameters?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">Show me the solution</h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>Arbitrary parameters are still finite, so you could just generate a
flat list of all the combinations, and iterate over that. Or you could
generate two lists and do a nested loop.</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>A relatively compact snakemake file collects interesting data.</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section>
</div>
    </main>
</div>
<!-- END  : inst/pkgdown/templates/content-extra.html -->

      </div>
<!--/div.row-->
      		<footer class="row footer mx-md-3"><hr>
<div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>
        
        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/README.md" class="external-link">Edit on GitHub</a>
        
	
        | <a href="https://github.com/carpentries-incubator/hpc-workflows/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/carpentries-incubator/hpc-workflows/" class="external-link">Source</a></p>
				<p><a href="https://github.com/carpentries-incubator/hpc-workflows/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:maintainers-hpc@lists.carpentries.org">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">
        
        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>
        
        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.2" class="external-link">sandpaper (0.16.2)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.3" class="external-link">pegboard (0.7.3)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.1" class="external-link">varnish (1.0.1)</a></p>
			</div>
		</footer>
</div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://carpentries-incubator.github.io/hpc-workflows/aio.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "HPC Carpentry, snakemake, workflows, hpc",
  "name": "All in One View",
  "creativeWorkStatus": "active",
  "url": "https://carpentries-incubator.github.io/hpc-workflows/aio.html",
  "identifier": "https://carpentries-incubator.github.io/hpc-workflows/aio.html",
  "dateCreated": "2023-04-19",
  "dateModified": "2024-01-30",
  "datePublished": "2024-01-30"
}

  </script><script>
		feather.replace();
	</script><!-- Matomo
    2022-11-07: we have gotten a notification that we have an overage for our
    tracking and I'm pretty sure this has to do with Workbench usage.
    Considering that I am not _currently_ using this tracking because I do not
    yet know how to access the data, I am turning this off for now.
  <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
    _paq.push(["setDomains", ["*.preview.carpentries.org","*.datacarpentry.github.io","*.datacarpentry.org","*.librarycarpentry.github.io","*.librarycarpentry.org","*.swcarpentry.github.io", "*.carpentries.github.io"]]);
    _paq.push(["setDoNotTrack", true]);
    _paq.push(["disableCookies"]);
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
          var u="https://carpentries.matomo.cloud/";
          _paq.push(['setTrackerUrl', u+'matomo.php']);
          _paq.push(['setSiteId', '1']);
          var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
          g.async=true; g.src='https://cdn.matomo.cloud/carpentries.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
        })();
  </script>
  End Matomo Code -->
</body>
</html><!-- END:   inst/pkgdown/templates/layout.html-->

